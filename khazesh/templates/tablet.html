{% load static %}
<!DOCTYPE html>

<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="shortcut icon" href="{% static 'images/site-badge.png' %}" type="image/png">
    <!-- <link
      href="https://fonts.googleapis.com/css?family=Roboto:400,700"
      rel="stylesheet"
    /> -->
    <!-- <link rel="stylesheet" href="{% static 'css/main.css' %}?v={{ STATIC_VERSION }}" /> -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}?v=2" />

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">


</head>
<!-- <script src='{% static "/js/main.js" %}'></script> -->
<script src={% static "/js/code.jquery.com_jquery-3.6.0.min.js" %}></script>

<body>
    <style>
        .green-text {
            color: green;
        }
        
        .red-text {
            color: red;
        }
        
        .price-tooltip:hover {
            display: block !important;
        }
        
        .price-tooltip-container {
            display: inline-block;
            position: relative;
            cursor: pointer;
            font-weight: 600;
        }
        
        .price-tooltip {
            display: none;
            position: absolute;
            top: 130%;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: linear-gradient(135deg, #ffffff, #f9f9f9);
            border: 1px solid #ddd;
            padding: 14px 16px;
            z-index: 100;
            min-width: 300px;
            max-width: 350px;
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .price-tooltip-container:hover .price-tooltip {
            display: block;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        .price-tooltip .tooltip-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
            color: #333;
        }
        
        .price-tooltip ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .price-tooltip li {
            padding: 6px 0;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed #eee;
        }
        
        .price-tooltip li:last-child {
            border-bottom: none;
        }
        
        .price-tooltip .tooltip-date {
            font-size: 12px;
            color: #777;
            margin-right: 8px;
        }
        
        .green-text {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .red-text {
            color: #e74c3c;
            font-weight: bold;
        }
    </style>


    <div>
        <div class="webiart-logs">
            <div class="webiart-mobile-logs d-none">
                <div class="webiart-logs-title">موبایل و تبلت</div>
                <div class="webiart-site-list"></div>
            </div>
            <div class="webiart-accessories-logs d-none">
                <div class="webiart-logs-title">لوازم جانبی</div>
                <div class="webiart-site-list"></div>
            </div>
            <button type="button" class="webiart-toggle-btn" data-show='hide'>
        <svg class="webiart-arrow-up d-none" shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 512 299.283"><path fill="#fff" d="M75.334 286.691c-64.764 36.929-96.186-15.595-60.203-51.975L215.997 25.104c33.472-33.472 46.534-33.472 80.006 0l200.866 209.612c35.983 36.38 4.561 88.904-60.203 51.975L256 189.339 75.334 286.691z"/></svg>
        <svg class="webiart-arrow-down"  shape-rendering="geometricPrecision" text-rendering="geometricPrecision" image-rendering="optimizeQuality" fill-rule="evenodd" clip-rule="evenodd" viewBox="0 0 512 299.283"><path fill="#fff" d="M75.334 12.591C10.57-24.337-20.852 28.186 15.131 64.566l200.866 209.613c33.472 33.471 46.534 33.471 80.006 0L496.869 64.566c35.983-36.38 4.561-88.903-60.203-51.975L256 109.944 75.334 12.591z"/></svg>
      </button>
        </div>


    </div>




    <div class="text-center">
        <a style="color: #e45c27;" href="https://bartardigital.com/" target="_blank">
            <img src='{% static "/images/logo.svg" %}' alt="برتر دیجیتال">
        </a>
    </div>

    <div class="webiart-nav">
        <a href="/">گوشی موبایل</a>
        <a href="/tablet" class="active">تبلت</a>
        <a href="/accessories/watchs">ساعت هوشمند</a>
        <a href="/accessories/handsfree">هندزفری</a>
        <a href="/accessories/powerbank">پاوربانک</a>
        <a href="/accessories/charger">شارژر</a>
        <a href="/accessories/speaker">اسپیکر</a>
    </div>

    <div class="s008">
        <form>
            <div class="inner-form">
                <div class="basic-search">
                    <div class="input-field">
                        <input id="search" type="text" placeholder="مدل تبلت یا ایدی را وارد کنید" autocomplete="off" />
                        <div class="icon-wrap">
                            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="20" viewBox="0 0 20 20">
                <path
                  d="M18.869 19.162l-5.943-6.484c1.339-1.401 2.075-3.233 2.075-5.178 0-2.003-0.78-3.887-2.197-5.303s-3.3-2.197-5.303-2.197-3.887 0.78-5.303 2.197-2.197 3.3-2.197 5.303 0.78 3.887 2.197 5.303 3.3 2.197 5.303 2.197c1.726 0 3.362-0.579 4.688-1.645l5.943 6.483c0.099 0.108 0.233 0.162 0.369 0.162 0.121 0 0.242-0.043 0.338-0.131 0.204-0.187 0.217-0.503 0.031-0.706zM1 7.5c0-3.584 2.916-6.5 6.5-6.5s6.5 2.916 6.5 6.5-2.916 6.5-6.5 6.5-6.5-2.916-6.5-6.5z">
                </path>
              </svg>
                        </div>
                    </div>
                </div>
                <div class="advance-search">
                    <span class="desc">جستجوی پیشرفته</span>
                    <div class="row">
                        <div class="input-field">
                            <div class="input-select">
                                <select id="siteInput" data-trigger="" name="choices-single-defaul" onChange="sendRequest_select()">
                  <option placeholder="" value="">سایت</option>
                  <option value="Hamrahtel">همراه تل</option>
                  <option value="Kasrapars"> کسری پارس</option>
                  <option value="Mobile140">موبایل ۱۴۰</option>
                  <option value="DigiKala">دیجی کالا</option>
                  <option value="Tecnolife">تکنو لایف</option>
                  <option value="Darsoo">دارسو</option>
                </select>
                            </div>
                        </div>
                        <div class="input-field">
                            <div class="input-select">
                                <select id="brandInput" data-trigger="" name="choices-single-defaul" onChange="sendRequest_select()">
                  <option placeholder="" value="">برند</option>
                  <!-- <option value="all">All</option> -->
                  <option style="color:green;" value="apple">اپل</option>
                  <option value="xiaomi">شیايومی</option>
                  <option value="samsung">سامسونگ</option>
                  <option value="poco">پوکو</option>
                  <option value="redmi">ردمی</option>

                </select>
                            </div>
                        </div>
                        <div id="siteInput" class="input-field">
                            <div class="input-select">
                                <select id="notActiveInput" data-trigger="" name="choices-single-defaul" onChange="sendRequest_select()">
                  <option placeholder="" value="">اکتیو</option>
                  <!-- <option value="all">All</option> -->
                  <option value="False">✅ : اکتیو</option>
                  <option value="True">❌ : اکتیو</option>
                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row second">
                        <div class="input-field">
                            <div class="input-select">
                                <select id="vietnamInput" data-trigger="" name="choices-single-defaul" onChange="sendRequest_select()">
                  <option placeholder="" value="">ویتنام</option>
                  <!-- <option value="all">All</option> -->
                  <option value="True">✅ : ویتنام</option>
                  <option value="False">❌ :‌ ویتنام</option>
                </select>
                            </div>
                        </div>
                        <div class="input-field">
                            <div class="input-select">
                                <select id="ramInput" data-trigger="" name="choices-single-defaul" onChange="sendRequest_select()">
                  <option placeholder="" value="">رم</option>
                  <option value="2GB">2GB</option>
                  <option value="3GB">3GB</option>
                  <option value="4GB">4GB</option>
                  <option value="6GB">6GB</option>
                  <option value="8GB">8GB</option>
                  <option value="12GB">12GB</option>
                  <option value="16GB">16GB</option>
                  <option value="24GB">24GB</option>
                </select>
                            </div>
                        </div>
                        <div class="input-field">
                            <div class="input-select">
                                <select id="memoryInput" data-trigger="" name="choices-single-defaul" onChange="sendRequest_select()">
                  <option placeholder="" value="">حافظه</option>
                  <option value="16">16GB</option>
                  <option value="32">32GB</option>
                  <option value="64">64GB</option>
                  <option value="128">128GB</option>
                  <option value="256">256GB</option>
                  <option value="512">512GB</option>
                  <option value="1TB">1TB</option>
                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row third">
                        <div class="input-field">
                            <div class="result-count">
                                <span id="result">0</span>نتیجه جستجو
                            </div>
                            <div class="group-btn">
                                <!-- <button class="btn-delete" id="delete">Reset</button>
                  <button class="btn-search">Search</button> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <style>
            {
                % comment %
            }
            
            .element {
                position: relative;
                padding: 8px;
                margin-bottom: 8px;
                font-size: 13px
            }
            
            {
                % endcomment %
            }
            
            .element {
                position: relative;
                display: grid;
                grid-template-columns: 1rem 1fr;
                grid-template-rows: auto auto;
                align-items: center;
                padding: 1rem 2rem;
            }
            
            .btn-delete {
                position: absolute;
                top: 0.2rem;
                right: 0.2rem;
                height: 1rem;
                width: 1rem;
                aspect-ratio: 1;
                border-radius: 50%;
                border: none;
                background-color: #fa5252;
                color: #e03131;
                font-size: 0.9rem;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .btn-delete:hover {
                background-color: var(--color-red-dark);
            }
            
            .custom-input {
                width: 100%;
                padding: 10px;
                border: 1px solid #ccc;
                border-radius: 5px;
                font-size: 16px;
                color: #333;
                outline: none;
            }
            
            .gray::placeholder {
                color: #ccc
            }
            
            .green::placeholder {
                color: rgb(0, 255, 0)
            }
            
            .red::placeholder {
                color: #e03131;
            }
        </style>
    </div>
    <table style="direction:rtl" class="container">
        <thead>
            <tr>
                <th>
                    <h1>#</h1>
                </th>
                <th>
                    <h1>برند</h1>
                </th>
                <th>
                    <h1>مدل</h1>
                </th>
                <th>
                    <h1>حافظه/رم</h1>
                </th>
                <th>
                    <h1>قیمت</h1>
                </th>
                <th>
                    <h1>اختلاف قیمت</h1>
                </th>

                <th>
                    <h1>تغیرات قیمت 24 ساعت</h1>
                </th>
                <th>
                    <h1>سایت</h1>
                </th>
                <th>
                    <h1>فروشنده</h1>
                </th>
                <th>
                    <h1>رنگ</h1>
                </th>
                <th>
                    <h1>ویتنام</h1>
                </th>
                <th>
                    <h1>اکتیو</h1>
                </th>
                <th>
                    <h1>ID</h1>
                </th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src='{% static "/js/extention/choices.js" %}'></script>
    <script>
        'use strict';
        const customSelects = document.querySelectorAll("select");
        const deleteBtn = document.getElementById("delete");
        const choices = new Choices("select", {
            searchEnabled: false,
            removeItemButton: true,
            itemSelectText: "",
        });

        for (let i = 0; i < customSelects.length; i++) {
            customSelects[i].addEventListener(
                "addItem",
                function(event) {
                    if (event.detail.value) {
                        let parent = this.parentNode.parentNode;
                        parent.classList.add("valid");
                        parent.classList.remove("invalid");
                    } else {
                        let parent = this.parentNode.parentNode;
                        parent.classList.add("invalid");
                        parent.classList.remove("valid");
                    }
                },
                false
            );
        }



        const create_td = function(i, obj, option) {

                const date = new Date(obj.updated_at);
                const now = new Date()
                const timeDiff = (now - date) / (1000 * 60)

                const fourHourInMiniute = (60 * 4) + 1

                // localize price_change_time
                const price_change_time = obj.price_change_time;
                const custom_id = obj.custom_id || ""
                let ChangeDate = null;
                let localChangeTime = null;
                if (Boolean(price_change_time)) {
                    ChangeDate = new Date(price_change_time);
                    localChangeTime = new Intl.DateTimeFormat("fa", option).format(
                        ChangeDate
                    )
                };

                const localTime = new Intl.DateTimeFormat("fa", option).format(
                    date
                );

                const min_price = obj.min_price / 10;
                const old_min_price = obj.old_min_price;
                let price_diff = "-";
                if (old_min_price) {
                    price_diff = min_price - old_min_price / 10;
                    //  price_diff = price_diff / 10;
                    console.log('price_diff', price_diff)
                    console.log('min_price', min_price)
                    console.log('old_min_price', old_min_price)
                    console.log("##############################################################")
                }

                let toLocalNumber = "0";
                if (price_diff != "-") {
                    const option = {
                        style: "currency",
                        // currency:
                    };
                    toLocalNumber = new Intl.NumberFormat("SY").format(
                        Math.abs(price_diff)
                    );
                }
                const toLocalMinPrice = new Intl.NumberFormat("SY").format(min_price);


                // برای نمایش tooltip حرفه‌ای، می‌توانید این JS اضافه کنید:
                document.querySelectorAll('.price-tooltip-container').forEach(container => {
                    const tooltip = container.querySelector('.price-tooltip');
                    container.addEventListener('mouseenter', () => tooltip.style.display = 'block');
                    container.addEventListener('mouseleave', () => tooltip.style.display = 'none');
                });
                const html = `<tr class=${!obj.status ? "dont_Exist" : ""}>
            <td id="td-counter" data-id=${obj.id}>${i + 1}</td>
            <td  >${obj.brand__name}</td>
            <td class="price_diff" id="model-title" data-title="${obj.title}" style="font-size:12px;"><a href=${obj.url} target="_blank"> <div style="height:100%;width:100%;">${obj.model}<span >${obj.title}</span></div></a></td>
            <td id="memory-ram" data-memory="${obj.memory}" data-ram="${obj.ram}" style="font-size:14px;">${obj.memory}/${obj.ram}</td>
            <td class="price_diff" style="font-size">${toLocalMinPrice + " ت"}
             <span>تاریخ بروزرسانی ${localTime}</span></td>
            <td  class="price_diff"  style="color:${price_diff > 0 ? "green" : "red"};">${price_diff ? toLocalNumber + " ت" : price_diff
        }<span>${localChangeTime ? ` آخرین تغییر قمیت در ${localChangeTime} بوده` : 'تغییر قیمت نداشته.'} </span></td>
           
        
        
        
        <td class="price_changes_24h" style="
        color:${obj.price_changes_24h && obj.price_changes_24h.length ? 
            (() => {
                const total = obj.price_changes_24h
                    .map(c => (Number(c.change) || 0) / 10)   // ✅ ریال → تومان
                    .reduce((sum, val) => sum + val, 0);
                return total > 0 ? '#00ff6c' : total < 0 ? '#e74c3c' : '#888';
            })() 
            : '#888'};
        position:relative; text-align:center;
    ">
    <div class="price-tooltip-container">
        ${obj.price_changes_24h && obj.price_changes_24h.length ? (() => {
            const total = obj.price_changes_24h
                .map(c => (Number(c.change) || 0) / 10)   // ✅ ریال → تومان
                .reduce((sum, val) => sum + val, 0);
            const icon = total > 0 
                ? '<i class="fas fa-arrow-up"></i>' 
                : total < 0 
                ? '<i class="fas fa-arrow-down"></i>' 
                : '';
            return `${icon} ${new Intl.NumberFormat("fa-IR").format(Math.abs(total))} ت`;
        })() : "بدون تغییر"}

        <div class="price-tooltip">
            ${obj.price_changes_24h && obj.price_changes_24h.length ? (() => {
                const total = obj.price_changes_24h
                    .map(c => (Number(c.change) || 0) / 10)   // ✅ ریال → تومان
                    .reduce((sum, val) => sum + val, 0);
                const cls = total > 0 ? 'green-text' : total < 0 ? 'red-text' : '';
                const icon = total > 0 
                    ? '<i class="fas fa-arrow-up"></i>' 
                    : total < 0 
                    ? '<i class="fas fa-arrow-down"></i>' 
                    : '';
                return `<div class="tooltip-header">
                    <i class="fas fa-chart-line"></i> جمع تغییرات: 
                    <span class="${cls}" style="margin-right: 10px;">${icon} ${new Intl.NumberFormat("fa-IR").format(Math.abs(total))} تومان</span>
                </div>`;
            })() : ''}

            <ul>
                ${obj.price_changes_24h && obj.price_changes_24h.length ? obj.price_changes_24h.map(c => {
                    const changeValue = (Number(c.change) || 0) / 10;   // ✅ ریال → تومان
                    const formattedVal = new Intl.NumberFormat("fa-IR").format(Math.abs(changeValue));
                    const changeDate = new Date(c.time);
                    const formatted = new Intl.DateTimeFormat("fa-IR", { 
                        hour:"2-digit", 
                        minute:"2-digit", 
                        day:"numeric", 
                        month:"long" 
                    }).format(changeDate);
                    const cls = changeValue > 0 ? 'green-text' : changeValue < 0 ? 'red-text' : '';
                    const icon = changeValue > 0 
                        ? '<i class="fas fa-arrow-up"></i>' 
                        : changeValue < 0 
                        ? '<i class="fas fa-arrow-down"></i>' 
                        : '';
                    return `
                        <li>
                            <span class="${cls}">${icon} ${formattedVal} تومان</span>
                            <span class="tooltip-date"><i class="far fa-clock"></i> ${formatted}</span>
                        </li>`;
                }).join('') : '<li><span style="color:#888;">تغییری ثبت نشده</span></li>'}
            </ul>
        </div>
    </div>
</td>
        <td id="site" data-site="${obj.site}" style="font-size:14px; padding:0;">${obj.site}</td>
            <td id="seller-guarantee" data-seller="${obj.seller}" data-guarantee="${obj.guarantee}" class="price_diff" style="font-size:14px;">${obj.seller}<span >${obj.guarantee || 'گارانتی ذخیره نشده'}</span></td>
            <td  ><div id="color-name" data-color-name="${obj.color_name}" style="width: 50%;
    float: right;font-size:13px;">${obj.color_name
        }</div>
    <div id="color-hex" data-color-name="${obj.color_hex}" style="background:${obj.color_hex};
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-top: 4px;
    margin-left: 9%;
    float: left;"></div>
   </td>
            <td >${obj.vietnam ? "✅" : "❌"}</td>
            <td >${obj.not_active ? "❌" : "✅"}</td>
            <!-- <td >${localTime}</td> -->
            <td  style="max-width:60px;">
             
                <input onfocus="onFocusFunc(this)" onfocusout="register_id(this, '${custom_id}')" class="custom-input gray" value="${custom_id}" placeholder="ثبت آیدی"/>
               
            </td>
          </tr>`;

      return html
    }

    let currentRequest = null;
    const debounce = (callback, wait) => {
      let timeoutId = null;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
          //callback.apply(this, args);
          callback(...args);
        }, wait);
      };
    }

    $(document).on('click', '.webiart-toggle-btn', function(){
      var status = $(this).attr('data-show');
      if(status == 'show'){
        $('.webiart-arrow-up, .webiart-mobile-logs, .webiart-accessories-logs').addClass('d-none', 1000);
        $('.webiart-arrow-down').removeClass('d-none');
        $(this).attr('data-show', 'hide');
      }else{
        
        $('.webiart-arrow-up, .webiart-mobile-logs, .webiart-accessories-logs').removeClass('d-none', 1000);
        $('.webiart-arrow-down').addClass('d-none');
        $(this).attr('data-show', 'show');
      }
    });


    function sendRequest() {
      // Get search parameters from user input or other elements
      // setTimeout(getLocationFromDb, 1000);
      // var $lock = $(this);

      if (currentRequest) {
        currentRequest.abort()
      }
      var model = $("#search").val();
      var brand = $("#brandInput").val();
      var ram = $("#ramInput").val();
      var memory = $("#memoryInput").val();
      var notActive = $("#notActiveInput").val();
      var site = $("#siteInput").val();
      var vietnam = $("#vietnamInput").val();

      var url =
        // "/ajax_search/?model=" +
        "/ajax_search/?model=" +
        model +
        "&brand=" +
        brand +
        "&ram=" +
        ram +
        "&memory=" +
        memory +
        "&not_active=" +
        notActive +
        "&site=" +
        site +
        "&vietnam=" +
        vietnam;

      // Make an AJAX request to the Django backend
      if (model || brand || ram || memory || notActive || site || vietnam) {
        currentRequest = $.ajax({
          url: url,
          method: "GET",
          data: {
            model: model,
            brand: brand,
            ram: ram,
            memory: memory,
            notActive: notActive,
            site: site,
            vietnam: vietnam,
          },
          success: function (response) {
            // Handle the response from Django
            console.log(model, memory, ram, brand, site, vietnam);
            // console.log(response);
            console.log(response);


            const option = {
              hour: "numeric",
              minute: "numeric",
              day: "numeric",
              month: "numeric",
              year: "numeric",
            };
            $("tbody").children().remove();

            for (const [i, obj] of response.entries()) {

              const html = create_td(i, obj, option)

              $("tbody").append(html);
            }

            let count = $("tbody").children().length;

            console.log(count);
            document.querySelector("#result").innerHTML = count;
            count = 0;

            // Update your frontend with the received data
          },
          error: function (xhr, status, error) {
            if (status !== 'abrot') {

              // Handle any errors
              console.error(xhr.responseText);
            }
          },
        });
      } else {
        $("tbody").children().remove();
        count = 0;
        document.querySelector("#result").innerHTML = count;
      }
      console.log();
    }

    const handleSearchRequest = debounce(sendRequest, 600)
    $("#search").on('keyup', handleSearchRequest)

    function site_name_accessories(site, status) {
      name = '';
      switch (site) {
        case 'Tellstar':
          name = "تل استار";
          break;
        case 'Diarhamrah':
            name = "دیار همراه";
            break;
        case 'Mobomin':
            name = "موبومین";
            break;
        case 'Taavrizh':
          name = "تاوریژ";
          break;
        case 'Hamrahtel':
          name = "همراه تل";
          break;
        case 'Kasrapars':
          name = "کسری پارس";
          break;
        case 'Mobile140':
          name = "موبایل 140";
          break;
        case 'Digikala':
          name = "دیجی کالا";
          break;
        case 'Tecnolife':
          name = "تکنو لایف";
          break;
        case 'Saymandigital':
          name = "سایمان دیجیتال";
          break;
        default:
          name="نامشخص";
      }
      if(status){
        return name;
      }else{
        return "<span class='text-warning'>" + name + "</span>";
      }
                  
    }

    function site_name(site, status) {
      name = '';
      switch (site) {
        case 'Tellstar':
          name = "تل استار - موبایل";
          break;
        case 'Diarhamrah':
            name = "دیار همراه - موبایل";
            break;
        case 'Mobomin':
            name = "موبومین - موبایل";
            break;
        case 'Taavrizh':
          name = "تاوریژ - موبایل";
          break;
        case 'Hamrahtel':
          name = "همراه تل - موبایل";
          break;
        case 'Kasrapars':
          name = "کسری پارس - موبایل";
          break;
        case 'Mobile140':
          name = "موبایل 140 - موبایل";
          break;
        case 'Digikala':
          name = "دیجی کالا - موبایل";
          break;
        case 'Tecnolife':
          name = "تکنو لایف - موبایل";
          break;
        case 'Saymandigital':
          name = "سایمان دیجیتال - موبایل";
          break;
          case 'Tellstar-tablet':
          name = "تل استار - تبلت";
          break;
        case 'Diarhamrah-tablet':
            name = "دیار همراه - تبلت";
            break;
        case 'Mobomin-tablet':
            name = "موبومین - تبلت";
            break;
        case 'Taavrizh-tablet':
          name = "تاوریژ - تبلت";
          break;
        case 'Hamrahtel-tablet':
          name = "همراه تل - تبلت";
          break;
        case 'Kasrapars-tablet':
          name = "کسری پارس - تبلت";
          break;
        case 'Mobile140-tablet':
          name = "موبایل 140 - تبلت";
          break;
        case 'Digikala-tablet':
          name = "دیجی کالا - تبلت";
          break;
        case 'Tecnolife-tablet':
          name = "تکنو لایف - تبلت";
          break;
        case 'Saymandigital-tablet':
          name = "سایمان دیجیتال - تبلت";
          break;
        case 'Darsoo-tablet':
          name = "دارسو  - تبلت";
          break;
          
        default:
          name="نامشخص";
      }

      if(status){
        return name;
      }else{
        return "<span class='text-warning'>" + name + "</span>";
      }
      
                  
    } 

    function get_site_status() {

      // Make an AJAX request to the Django backend

      $.ajax({
        url: '/site_status',
        method: "GET",
        data: {},
        success: function (response) {
          const option = {
            hour: "2-digit",
            minute: "2-digit",
            day: "numeric",
            month: "long",
          };

          var html = '';
          var accessories = '';
          for (const [i, obj] of response.mobile.entries()) {

            const date = new Date(obj.last_executed);
            const now = new Date()
            const timeDiff = (now - date) / (1000 * 60)

            const localTime = new Intl.DateTimeFormat("fa", option).format(
              date
            );
            if(timeDiff < 50){
              var color = '#00a92a';
            }else if(timeDiff > 50 && timeDiff < 80){
              var color = '#fbff2b';
            }else if(timeDiff > 80){
              var color = '#d80000';
            }else{
              var color = '#000';
            }

            html += '<div class="webiart-site-item"><div class="d-flex"><div class="webiart-site-status"><svg  version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 31.955 31.955" xml:space="preserve"><g><path style="fill:'+color+';" d="M27.25,4.655C20.996-1.571,10.88-1.546,4.656,4.706C-1.571,10.96-1.548,21.076,4.705,27.3 c6.256,6.226,16.374,6.203,22.597-0.051C33.526,20.995,33.505,10.878,27.25,4.655z"/><circle style="fill:'+color+';" cx="15.979" cy="15.977" r="6.117"/></g></svg></div><div class="webiart-site-title">' + site_name(obj.name, obj.status) + '</div></div><div class="webiart-site-date">'+localTime+'</div></div>';

          }

          
          for (const [i, obj] of response.accessories.entries()) {

            const date = new Date(obj.last_executed);
            const now = new Date()
            const timeDiff = (now - date) / (1000 * 60)

            const localTime = new Intl.DateTimeFormat("fa", option).format(
              date
            );
            if(timeDiff < 45){
              var color = '#00a92a';
            }else if(timeDiff > 45 && timeDiff < 80){
              var color = '#fbff2b';
            }else if(timeDiff > 80){
              var color = '#d80000';
            }else{
              var color = '#000';
            }

            accessories += '<div class="webiart-site-item"><div class="d-flex"><div class="webiart-site-status"><svg  version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 31.955 31.955" xml:space="preserve"><g><path style="fill:'+color+';" d="M27.25,4.655C20.996-1.571,10.88-1.546,4.656,4.706C-1.571,10.96-1.548,21.076,4.705,27.3 c6.256,6.226,16.374,6.203,22.597-0.051C33.526,20.995,33.505,10.878,27.25,4.655z"/><circle style="fill:'+color+';" cx="15.979" cy="15.977" r="6.117"/></g></svg></div><div class="webiart-site-title">' + site_name_accessories(obj.name, obj.status) + '</div><div class="webiart-item-space">-</div><div class="webiart-site-category">'+obj.category__name_fa+'</div></div><div class="webiart-site-date">'+localTime+'</div></div>';

          }
          $(".webiart-mobile-logs").children('.webiart-site-list').html(html);
          $(".webiart-accessories-logs").children('.webiart-site-list').html(accessories);



          // Update your frontend with the received data
        },
        error: function (xhr, status, error) {
          // Handle any errors
          console.error(xhr.responseText);
        },
      });

    }
    
    get_site_status();
    setInterval(function(){
      get_site_status()
  }, 60000)

    function sendRequest_select() {
      // Get search parameters from user input or other elements
      // setTimeout(getLocationFromDb, 1000);
      // var $lock = $(this);
      var model = $("#search").val();
      var brand = $("#brandInput").val();
      var ram = $("#ramInput").val();
      var memory = $("#memoryInput").val();
      var notActive = $("#notActiveInput").val();
      var site = $("#siteInput").val();
      var vietnam = $("#vietnamInput").val();

      var url =
        // "https://dalgaweb.ir/ajax_search/?model=" +
        "/ajax_search/?type=tablet&model=" +
        model +
        "&brand=" +
        brand +
        "&ram=" +
        ram +
        "&memory=" +
        memory +
        "&not_active=" +
        notActive +
        "&site=" +
        site +
        "&vietnam=" +
        vietnam;

      // Make an AJAX request to the Django backend

      $.ajax({
        url: '/ajax_search/',
        method: "GET",
        data: {
          type: 'tablet',
          model: model,
          brand: brand,
          ram: ram,
          memory: memory,
          notActive: notActive,
          site: site,
          vietnam: vietnam,
        },
        success: function (response) {
          // Handle the response from Django
          //console.log(model, memory, ram, brand, site, vietnam);
          // console.log(response);
          //console.log(response);

          // const removeElemnt = function (tagName) {
          //   var element = document.getElementsByTagName(tagName),
          //     index;

          //   for (index = element.length - 1; index >= 0; index--) {
          //     element[index].parentNode.removeChild(element[index]);
          //   }
          // };

          // removeElemnt("tbody");
          const option = {
            hour: "numeric",
            minute: "numeric",
            day: "numeric",
            month: "numeric",
            year: "numeric",
          };
          $("tbody").children().remove();

          // if ($("#search").val() == "") {
          //   $("tbody").children().remove();
          // }

          for (const [i, obj] of response.entries()) {

            const html = create_td(i, obj, option)

            $("tbody").append(html);
          }

          let count = $("tbody").children().length;

          console.log(count);
          document.querySelector("#result").innerHTML = count;
          count = 0;

          // Update your frontend with the received data
        },
        error: function (xhr, status, error) {
          // Handle any errors
          console.error(xhr.responseText);
        },
      });

      console.log();
    }

    // async function fetchForSetCustomId(title, memory, ram, color_name, site, seller, guarantee,customId, input) {
    async function fetchForSetCustomId(id, customId, input) {
      try {
        input.placeholder = "..."

        // const res = await fetch(`/set_custom_mobile_id/?title=${title}&memory=${memory}&ram=${ram}&color_name=${color_name}&site=${site}&seller=${seller}&guarantee=${guarantee}
        //&custom_id=${customId}`, {
        //      method: "GET"
        // });
        const res = await fetch(`/set_custom_mobile_id/?id=${id}&custom_id=${customId}`, {
          method: "GET"
        });

        if (!res.ok) {
          console.log(res)
          throw new Error("مشکل کانکشن");
        }

        const data = await res.json();

        if (data.Response === "Faild") {
          throw new Error(data.reason);
        }

        if (data.Response === "success") {
          input.value = customId
          input.placeholder = ""
          input.style.borderWidth = "2px"
          input.style.borderColor = "rgb(0,150,0)"
          input.classList.remove('gray')
          input.classList.remove('red')
          input.classList.add("green")
          input.style.color = "rgb(0,150,0)"

          return 1

        }
        //console.log(data);
      } catch (error) {
        showInputError(input, error.message)
      }
    }
    function showInputError(element, errorMessage) {
      element.value = ""
      element.placeholder = errorMessage;
      element.classList.remove('gray')
      element.classList.remove('green')
      element.classList.add("red")
      element.style.borderColor = "red"
      element.style.borderWidth = "2px"
    }

    function containsOnlyDigits(str) {
      return /^\d+$/.test(str);
    }
    async function register_id(input, custom_id) {
      let coustomID = custom_id
      const inputValue = toEnglishDigits(input.value)
      console.log(inputValue, custom_id, !containsOnlyDigits(inputValue), inputValue === custom_id)

      //if (inputValue === coustomID) return

      if (!containsOnlyDigits(inputValue) && inputValue) {
        showInputError(input, "فقط عدد")

        return
      }

      const parentTR = input.closest('tr');

      const titleElement = parentTR.querySelector('#model-title');
      const memoryElement = parentTR.querySelector('#memory-ram');
      const ramElement = parentTR.querySelector('#memory-ram');
      const colorElement = parentTR.querySelector('#color-name');
      const siteElement = parentTR.querySelector('#site')
      const sellerGuaranteeElement = parentTR.querySelector('#seller-guarantee')
      const modelId = parentTR.querySelector('#td-counter').dataset.id

      if (titleElement && memoryElement && ramElement && colorElement) {
        /*  const title =  encodeURIComponent(titleElement.dataset.title.trim())
          const memory = memoryElement.dataset.memory;
          const ram = ramElement.dataset.ram;
          const color_name = colorElement.dataset.colorName;
          const site = siteElement.dataset.site
          const seller = encodeURIComponent(sellerGuaranteeElement.dataset.seller.trim())
          const guarantee = encodeURIComponent(sellerGuaranteeElement.dataset.guarantee.trim())*/

        //const isSuccess = await fetchForSetCustomId(title, memory, ram, color_name, site, seller, guarantee, inputValue ,input);
        const isSuccess = await fetchForSetCustomId(modelId, inputValue, input);
        if (isSuccess) customId = inputValue;

      } else {
        showInputError(input, "اطلاعات مورد نیاز موجود نیست!")
      }
    }

    function onFocusFunc(input) {
      input.innerHTML = "ثبت آيدی"
      input.classList.remove('green')
      input.classList.remove('red')
      input.classList.add('gray')
      input.style.borderColor = "rgb(0,0,0)"
      input.style.borderWidth = "1px"
      input.style.color = "rgb(0,0,0)"
    }

    function toEnglishDigits(str) {
      // convert persian digits [۰۱۲۳۴۵۶۷۸۹]
      var e = "۰".charCodeAt(0);
      str = str.replace(/[۰-۹]/g, function (t) {
        return t.charCodeAt(0) - e;
      });

      // convert arabic indic digits [٠١٢٣٤٥٦٧٨٩]
      e = "٠".charCodeAt(0);
      str = str.replace(/[٠-٩]/g, function (t) {
        return t.charCodeAt(0) - e;
      });
      return str;
    }
    </script>
</body>

</html>